---
output: html_document
---

## Send Emails with Postfix

<strong>Postfix</strong> - A popular open-source Mail Transfer Agent (MTA) that can be used to route and deliver emails on a Linux system

<strong>Docker</strong> - A software platform that allows developers to build, test, deploy, and run applications using containers

In this post, I will go over tutorials on how to send emails from a docker container using Postfix installed on the host machine. In my previous posts, I mentioned how you can <a href='#dockerize'>dockerize the Xposome application</a>. The Xposome application has four pages: <a href='#home-page'>Home Page</a>, <a href='#overview-page'>Overview Page</a>, <a href='#portal-page'>Portal Page</a>, and <a href='#sign-in-page'>Sign-In Page</a>. In the Sign-In Page, there is an option that allows users to retrieve their passwords if they forgot their login credentials. Postfix is actually used here to send a notification email to the users with a temporary password that allows them to gain access to the portal again.

Here are the five steps to set-up Postfix and send new passwords to users as they forgot their login credentials:

1.	Install Postfix
2.	Dockerize the Xposome application locally or pull the image from Docker Hub
3.	Configure Postfix to listen to requests from the Xposome containers
4.	Write an email to test the Postfix Mail Server
5.	Check to see if the email is sent correctly

#### Step 1: Install Postfix

Depending on your Operating System, for mine, I have CentOS 8 server. Therefore, I will use this <a target="blank" href="https://www.linuxtechi.com/install-configure-postfix-mailserver-centos-8/">documenation</a> on how to install and configure postfix mail server on CentOS 8. You can also see this <a target="blank" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-on-ubuntu-16-04">link</a> to install and configure Postfix on Ubuntu 16.04.

#### Step 2: Dockerize the Xposome application locally or pull the image from Docker Hub

See my previous post <a href='#dockerize'>here</a> for more details

#### Step 3: Configure Postfix to listen to requests from the Xposome container

After Postfix is installed, the main configuration files is stored at <span class="highlight-text">/etc/postfix/main.cf</span>.

To configure Postfix to listen to requests from the Xposome container, there is something called <span class="highlight-text">docker bridge (docker0)</span> which acts as a bridge between the ethernet port and the docker container so that data can go back and forth. Hence, we want Postfix to listen on the docker0 interface. To do that, type <span class="highlight-text">ifconfig</span> on your host system to find out the bridge address and set your Postfix to listen on it.

<a href="www/postfix.png" target="blank"><img class="img-box" src="www/postfix.png"></a>

As you can see in the image above, the IP address is 172.17.0.1

In the Postfix configuration file (/etc/postfix/main.cf), set

<p class="code">inet_interfaces = 172.17.0.1</p>

While you are there, add your actual docker container ip address to mynetworks

<p class="code">mynetworks = 172.17.0.5</p>

172.17.0.5 is the private IP address of the Xposome container on my machine

You can find the IP address for your docker container by

<p class="code">
    docker inspect [container_id/container_name]
</p>

#### Step 4: Write an email to test the Postfix Mail Server

Here is an email function (written in R) that sends a temporary password to users who forgot their login credentials:

    sendpassword <- function(from_sender="montilab@bu.edu", to_recipient="montilab@bu.edu", recipient_first="Montilab", recipient_last="Montilab", recipient_account="Montilab", tmp_pwd){
      
      recipient=paste(recipient_first, recipient_last)
      
      msg <- mime_part(
        paste0(
          '<!DOCTYPE>',
          '<html>',
          '<head>',
          '<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>',
          '<meta name="viewport" content="width=device-width, initial-scale=1.0"/>',
          '<title>HTML MESSAGE</title>',
          '<style type="text/css">',
          '</style>',
          '</head>',
          '<body>',
          '<p>Hi <strong>', recipient_first, ',</strong></p>',
          '<p>The password for your Xposome account has changed.</p>',
          '<p></p>',
          '<p>Username: <strong>', recipient_account, '</strong></p>',
          '<p>Temporary password: <strong>', tmp_pwd, '</strong></p>',
          '<br>',
          '<p>Log back in? Follow this link, <strong>https://montilab.bu.edu/Xposome/?page=sign_in</strong></p>',
          '<br>',
          '<p>Best,</p>',
          '<p>Montilab Team</p>',
          '</body>',
          '</html>' 
        )
      )
      
      ## Override content type.
      msg[["headers"]][["Content-Type"]] <- "text/html"
      
      from <- paste0("\"Montilab Team\"<", from_sender, ">")
      to <- paste0("\"", recipient, "\"<", to_recipient, ">", collapse="")
      subject <- "Temporary password for Xposome"
      body <- list(msg)
      sendmail(from, to, subject, body, control=list(smtpServer="smtp.bu.edu", smtpPort="25"))
      
    }

On the Xposome application, there is a Sign-In Page. When a user clicks on the <span class="highlight-text">forgot password?</span> link, a modal dialog will pop up. The modal dialog requires the users to provide their user account information and by clicking on the submit button, a new temporary password will be send to his/her email. Afterward, they can use the temporary password to log back into the Xposome database and make edits to the portal.
    
Here a snapshoot of the modal dialog in the Sign-In Page:

<a href="www/forgot-password.png" target="blank"><img class="img-box" src="www/forgot-password.png" width="100%"></a>
 
#### Step 5: Check to see if the email sent correctly

If you are using the same email format that I have structured above, you should receive an email similar to this one.

<a href="www/email.png"><img class="img-box" src="www/email.png" width="812px" height="500px"></a>

<br><br>
